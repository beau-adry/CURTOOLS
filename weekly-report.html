<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Inventory Report</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="curdesk.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="navbar">
        <a href="index.html" class="logo">
            <img src="adry_logo.png" alt="AdryTech Logo">
        <a href="inventory-management.html" class="tab-button">Ticket Handling Toolset</a>
        <a href="weekly-report.html" class="tab-button">Weekly Report</a>
        <a href="password-generator.html" class="tab-button">Password Generator</a>
    </div>

    <div class="content">
        <h1>Weekly Inventory Report</h1>
        
        <div class="report-wrapper">
            <p id="reportTitle" class="report-title"></p>
            <button class="copy-button" onclick="copyToClipboard('reportTitle', this)">Copy</button>
        </div>

        <h2>Upload Asset JSON File</h2>
        <input type="file" id="assetFileInput" accept=".json" />
        <button onclick="processAssetFile()">Generate Asset Report</button>

        <h2>Upload Consumables JSON File</h2>
        <input type="file" id="accessoryFileInput" accept=".json" />
        <button onclick="processAccessoryFile()">Add Consumables to Report</button>

        <h2>Asset and Consumable Report</h2>
        <div id="reportTable"></div>

        <h2>Below Par Report</h2>
        <div id="belowParReport"></div>
        <button onclick="generatePDF()">Generate PDF</button>
        <button onclick="generateTicketResponse()">Generate & Copy Ticket Response</button>
    </div>

    <script>
        let assetData = null;
        let accessoryData = null;

        function generateTicketResponse() {
    // Par levels for each item type
    const desktopPar = 12;
    const laptopPar = 6;
    const monitorPar = 40;

    // Asset counts
    let desktopsCount = assetData["Desktop"] ? assetData["Desktop"].count : 0;
    let laptopsCount = assetData["Laptop"] ? assetData["Laptop"].count : 0;

    // Monitor count
    let monitorsCount = accessoryData["Monitor"] ? accessoryData["Monitor"].count : 0;

    // Calculate items below par
    let desktopBelow = desktopPar - desktopsCount > 0 ? desktopPar - desktopsCount : 0;
    let laptopBelow = laptopPar - laptopsCount > 0 ? laptopPar - laptopsCount : 0;
    let monitorBelow = monitorPar - monitorsCount > 0 ? monitorPar - monitorsCount : 0;

    // Generate response message
    let response = `Hello Jason,\n\nAttached is the current inventory report.\n\nWe currently have the following kits available:\n${desktopsCount}x Desktops\n${laptopsCount}x Laptops\n${monitorsCount}x Monitors`;

    // Add information about items below par, if any
    if (desktopBelow > 0 || laptopBelow > 0 || monitorBelow > 0) {
        response += `\n\nWe are below par levels and need to order the following:`;
        if (desktopBelow > 0) {
            response += `\n${desktopBelow}x Dell Optiplex's`;
        }
        if (laptopBelow > 0) {
            response += `\n${laptopBelow}x Laptops`;
        }
        if (monitorBelow > 0) {
            response += `\n${monitorBelow}x Monitors`;
        }
    }

    response += `\n\nThank you,\nAdrytech Support`;

    // Copy the generated response to clipboard
    const tempInput = document.createElement('textarea');
    tempInput.value = response;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);

    // Optional: Add visual feedback to the button
    const button = document.querySelector('button[onclick="generateTicketResponse()"]');
    button.textContent = "Copied!";
    button.classList.add('copied');
    
    setTimeout(() => {
        button.textContent = "Generate & Copy Ticket Response";
        button.classList.remove('copied');
    }, 2000);
}


        function displayReportTitle() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(today.setDate(today.getDate() + mondayOffset));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const mondayString = monday.toLocaleDateString('en-US', options).replace(/\//g, '-');
            const sundayString = sunday.toLocaleDateString('en-US', options).replace(/\//g, '-');
            const reportTitle = `Currance Weekly Inventory ${mondayString}/${sundayString}`;
            document.getElementById('reportTitle').textContent = reportTitle;
        }

        function copyToClipboard(elementId, buttonElement) {
            const textToCopy = document.getElementById(elementId).textContent;
            const tempInput = document.createElement('textarea');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);

            buttonElement.classList.add('copied');
            setTimeout(() => {
                buttonElement.classList.remove('copied');
            }, 2000);
        }

        function processAssetFile() {
            const fileInput = document.getElementById('assetFileInput');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        assetData = parseAssets(jsonData.data);
                        displayParsedData();
                    } catch (error) {
                        alert('Invalid asset JSON file.');
                    }
                };
                reader.readAsText(file);
            } else {
                alert('Please upload an asset JSON file.');
            }
        }

        function processAccessoryFile() {
            const fileInput = document.getElementById('accessoryFileInput');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const jsonData = JSON.parse(event.target.result);
                        accessoryData = parseConsumables(jsonData.data);
                        displayParsedData();
                    } catch (error) {
                        alert('Invalid consumables JSON file.');
                    }
                };
                reader.readAsText(file);
            } else {
                alert('Please upload a consumables JSON file.');
            }
        }

        function parseAssets(data) {
            const parLevels = { "Desktop": 12, "Laptop": 6 };
            const categories = { "Desktop": { count: 0, parLevel: parLevels["Desktop"], missing: 0 }, "Laptop": { count: 0, parLevel: parLevels["Laptop"], missing: 0 } };

            data.forEach(item => {
                if (item["Status"] === "Deployable") {
                    if (item["Category"] === "Desktops") categories["Desktop"].count += 1;
                    else if (item["Category"] === "Laptops") categories["Laptop"].count += 1;
                }
            });

            for (const key in categories) {
                if (categories[key].count < categories[key].parLevel) {
                    categories[key].missing = categories[key].parLevel - categories[key].count;
                }
            }

            return categories;
        }

        function parseConsumables(data) {
            const parLevels = {
                "Monitor": 40,
                "Accessory Kit": 18
            };

            const categories = {
                "Monitor": { count: 0, parLevel: parLevels["Monitor"], missing: 0, models: {} },
                "Accessory Kit": { count: 0, parLevel: parLevels["Accessory Kit"], missing: 0 }
            };

            data.forEach(item => {
                const category = item["Category"];
                const name = item["Name"];
                const model = item["Model No."];
                const remaining = parseInt(item["Remaining"], 10) || 0;

                if (category === "Monitors" && model === "E2424HS") {
                    categories["Monitor"].count += remaining;
                    if (!categories["Monitor"].models[model]) {
                        categories["Monitor"].models[model] = 0;
                    }
                    categories["Monitor"].models[model] += remaining;
                } else if (category === "Accessory Kits" && name === "Accessory Kit") {
                    categories["Accessory Kit"].count += remaining;
                }
            });

            for (const key in categories) {
                if (categories[key].count < categories[key].parLevel) {
                    categories[key].missing = categories[key].parLevel - categories[key].count;
                }
            }

            return categories;
        }

        function displayParsedData() {
            const reportDiv = document.getElementById('reportTable');
            const belowParDiv = document.getElementById('belowParReport');
            reportDiv.innerHTML = '';
            belowParDiv.innerHTML = '';

            const table = document.createElement('table');
            table.setAttribute('border', '1');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.textAlign = 'left';

            const headers = ['Category', 'Current Inventory', 'Par Level', 'Missing to Meet Par', 'Models'];
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.style.padding = '10px';
                th.style.backgroundColor = '#333';
                th.style.color = '#fff';
                th.appendChild(document.createTextNode(headerText));
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const mergedCategories = { ...assetData, ...accessoryData };

            for (const category in mergedCategories) {
                const categoryData = mergedCategories[category];
                const row = document.createElement('tr');

                const categoryCell = document.createElement('td');
                categoryCell.style.padding = '10px';
                categoryCell.appendChild(document.createTextNode(category));

                const inventoryCell = document.createElement('td');
                inventoryCell.style.padding = '10px';
                inventoryCell.appendChild(document.createTextNode(categoryData.count));

                const parCell = document.createElement('td');
                parCell.style.padding = '10px';
                parCell.appendChild(document.createTextNode(categoryData.parLevel));

                const missingCell = document.createElement('td');
                missingCell.style.padding = '10px';
                missingCell.appendChild(document.createTextNode(categoryData.missing > 0 ? categoryData.missing : 'Above Par'));

                const modelsCell = document.createElement('td');
                modelsCell.style.padding = '10px';
                if (category === "Monitor" && Object.keys(categoryData.models).length > 0) {
                    const modelsList = document.createElement('ul');
                    for (const model in categoryData.models) {
                        const modelItem = document.createElement('li');
                        modelItem.appendChild(document.createTextNode(`${model}: ${categoryData.models[model]}`));
                        modelsList.appendChild(modelItem);
                    }
                    modelsCell.appendChild(modelsList);
                } else {
                    modelsCell.appendChild(document.createTextNode("No model numbers available"));
                }

                row.appendChild(categoryCell);
                row.appendChild(inventoryCell);
                row.appendChild(parCell);
                row.appendChild(missingCell);
                row.appendChild(modelsCell);

                tbody.appendChild(row);
            }

            table.appendChild(tbody);
            reportDiv.appendChild(table);
        }

        function generatePDF() {
    // Ensure jsPDF is properly initialized
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Headers for the PDF table
    const headers = ['Category', 'Current Inventory', 'Par Level', 'Missing to Meet Par', 'Models'];
    const rows = [];

    // Extract table data from the report table for PDF
    const tableRows = document.querySelectorAll('#reportTable table tbody tr');
    tableRows.forEach(row => {
        const columns = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
        
        // Format the "Models" cell for monitors, if applicable
        if (columns[0] === "Monitor") {
            const modelsCell = row.querySelector('td:nth-child(5)').innerText;
            columns[4] = modelsCell.split('\n').join(', ').trim(); // Join model items into a single string
        }
        rows.push(columns);
    });

    // Use autoTable to add the table to the PDF
    doc.autoTable({
        head: [headers],
        body: rows,
        startY: 20,
        theme: 'grid',
        styles: {
            halign: 'left',
            fillColor: [52, 73, 94],
            textColor: [255, 255, 255],
        },
        headStyles: {
            fillColor: [34, 34, 34],
            textColor: [255, 255, 255],
        },
        bodyStyles: {
            fillColor: [245, 245, 245],
            textColor: [0, 0, 0],
        },
        alternateRowStyles: {
            fillColor: [240, 240, 240],
        }
    });

    // Set the title and format file name
    const reportTitle = document.getElementById('reportTitle').textContent;
    doc.setFontSize(16);
    doc.text(reportTitle, 14, 15);

    // Create a file name, replacing special characters
    const fileName = reportTitle.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '') + '.pdf';
    
    // Save the PDF
    doc.save(fileName);
}

        window.onload = displayReportTitle;
    </script>

    <style>
        .copied {
            background-color: #28a745 !important;
            color: white !important;
        }
    </style>
</body>
</html>
